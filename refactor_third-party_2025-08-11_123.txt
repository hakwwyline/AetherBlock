Refactor third-party authentication for middleware (legacy)
